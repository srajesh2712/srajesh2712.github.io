<!DOCTYPE html>
<html lang="en" dir="auto" data-theme="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Part 4 - Deep Dive: How Database Indexing Works (The B-Tree) | Beyond the Bytes</title>
<meta name="keywords" content="Databases, Performance, Computer Science">
<meta name="description" content="
The &ldquo;Heavy Data&rdquo; Reality: TSVectors

I noticed you are building search_vector for your topic table using to_tsvector. This adds a new layer to our 8 KB Page math:
The Box Size: Our UUID was 16 bytes. A tsvector of a description can be 500&#43; bytes.

The Denominator: Instead of fitting 819 entries in an 8 KB page, a search index (GIN index) might only fit 10-15 entries per page.

The Performance Impact: This is why Full-Text Search is &quot;heavy.&quot; Every search requires the CPU to decompress these large blocks and the Disk to fetch much larger pages.


Final Implementation Checklist (Postgres 17.7)

Now that you have pgcrypto installed and the function tested, follow these steps to move your agent, user, and topic tables to the new standard:">
<meta name="author" content="Rajesh Subramanian">
<link rel="canonical" href="http://localhost:1313/posts/drafts/part4-index-introduction/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.45da07cc2f1287a2aed2f0e5d5f6a80a124756a1c1228703eebc30c546fb9f0e.css" integrity="sha256-RdoHzC8Sh6Ku0vDl1faoChJHVqHBIocD7rwwxUb7nw4=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/posts/drafts/part4-index-introduction/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
                color-scheme: dark;
            }

            .list {
                background: var(--theme);
            }

            .toc {
                background: var(--entry);
            }
        }

        @media (prefers-color-scheme: light) {
            .list::-webkit-scrollbar-thumb {
                border-color: var(--code-bg);
            }
        }

    </style>
</noscript>
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.querySelector("html").dataset.theme = 'dark';
    } else if (localStorage.getItem("pref-theme") === "light") {
       document.querySelector("html").dataset.theme = 'light';
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.querySelector("html").dataset.theme = 'dark';
    } else {
        document.querySelector("html").dataset.theme = 'light';
    }

</script><meta property="og:url" content="http://localhost:1313/posts/drafts/part4-index-introduction/">
  <meta property="og:site_name" content="Beyond the Bytes">
  <meta property="og:title" content="Part 4 - Deep Dive: How Database Indexing Works (The B-Tree)">
  <meta property="og:description" content=" The ‚ÄúHeavy Data‚Äù Reality: TSVectors I noticed you are building search_vector for your topic table using to_tsvector. This adds a new layer to our 8 KB Page math:
The Box Size: Our UUID was 16 bytes. A tsvector of a description can be 500&#43; bytes. The Denominator: Instead of fitting 819 entries in an 8 KB page, a search index (GIN index) might only fit 10-15 entries per page. The Performance Impact: This is why Full-Text Search is &#34;heavy.&#34; Every search requires the CPU to decompress these large blocks and the Disk to fetch much larger pages. Final Implementation Checklist (Postgres 17.7) Now that you have pgcrypto installed and the function tested, follow these steps to move your agent, user, and topic tables to the new standard:">
  <meta property="og:locale" content="en-us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2026-03-29T05:55:00+00:00">
    <meta property="article:modified_time" content="2026-03-29T05:55:00+00:00">
    <meta property="article:tag" content="Databases">
    <meta property="article:tag" content="Performance">
    <meta property="article:tag" content="Computer Science">
      <meta property="og:see_also" content="http://localhost:1313/posts/2026/03/22/part2-index-introduction/">
      <meta property="og:see_also" content="http://localhost:1313/posts/2026/03/22/part1-index-introduction/">
      <meta property="og:see_also" content="http://localhost:1313/posts/drafts/part3-index-introduction/">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Part 4 - Deep Dive: How Database Indexing Works (The B-Tree)">
<meta name="twitter:description" content="
The &ldquo;Heavy Data&rdquo; Reality: TSVectors

I noticed you are building search_vector for your topic table using to_tsvector. This adds a new layer to our 8 KB Page math:
The Box Size: Our UUID was 16 bytes. A tsvector of a description can be 500&#43; bytes.

The Denominator: Instead of fitting 819 entries in an 8 KB page, a search index (GIN index) might only fit 10-15 entries per page.

The Performance Impact: This is why Full-Text Search is &quot;heavy.&quot; Every search requires the CPU to decompress these large blocks and the Disk to fetch much larger pages.


Final Implementation Checklist (Postgres 17.7)

Now that you have pgcrypto installed and the function tested, follow these steps to move your agent, user, and topic tables to the new standard:">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "http://localhost:1313/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Part 4 - Deep Dive: How Database Indexing Works (The B-Tree)",
      "item": "http://localhost:1313/posts/drafts/part4-index-introduction/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Part 4 - Deep Dive: How Database Indexing Works (The B-Tree)",
  "name": "Part 4 - Deep Dive: How Database Indexing Works (The B-Tree)",
  "description": " The \u0026ldquo;Heavy Data\u0026rdquo; Reality: TSVectors I noticed you are building search_vector for your topic table using to_tsvector. This adds a new layer to our 8 KB Page math:\nThe Box Size: Our UUID was 16 bytes. A tsvector of a description can be 500+ bytes. The Denominator: Instead of fitting 819 entries in an 8 KB page, a search index (GIN index) might only fit 10-15 entries per page. The Performance Impact: This is why Full-Text Search is \u0026quot;heavy.\u0026quot; Every search requires the CPU to decompress these large blocks and the Disk to fetch much larger pages. Final Implementation Checklist (Postgres 17.7) Now that you have pgcrypto installed and the function tested, follow these steps to move your agent, user, and topic tables to the new standard:\n",
  "keywords": [
    "Databases", "Performance", "Computer Science"
  ],
  "articleBody": " The ‚ÄúHeavy Data‚Äù Reality: TSVectors I noticed you are building search_vector for your topic table using to_tsvector. This adds a new layer to our 8 KB Page math:\nThe Box Size: Our UUID was 16 bytes. A tsvector of a description can be 500+ bytes. The Denominator: Instead of fitting 819 entries in an 8 KB page, a search index (GIN index) might only fit 10-15 entries per page. The Performance Impact: This is why Full-Text Search is \"heavy.\" Every search requires the CPU to decompress these large blocks and the Disk to fetch much larger pages. Final Implementation Checklist (Postgres 17.7) Now that you have pgcrypto installed and the function tested, follow these steps to move your agent, user, and topic tables to the new standard:\nStep,Action,SQL Command 1,Apply Default,ALTER TABLE agent ALTER COLUMN id SET DEFAULT generate_uuid_v7(); 2,Apply Default,ALTER TABLE topic ALTER COLUMN id SET DEFAULT generate_uuid_v7(); 3,Repack Pages,REINDEX TABLE agent; 4,Verify,Run the Density Query again to see the score move closer to 0.9+.\n30. The ‚ÄúSmoking Gun‚Äù: Analyzing the 1.08% Density The result you provided from pgstatindex (avg_leaf_density: 1.08) is the ultimate proof of the UUID v4 problem.\nThe Math of the 1.08% Page Size: 8,192 bytes (8 KB). Used Space: $8192 \\times 0.0108 = \\mathbf{88.47 \\text{ bytes}}$. Wasted Space: 8,103 bytes. Because your UUIDs are random, PostgreSQL had to allocate a full 8 KB page (the ‚Äúwarehouse‚Äù) but has only parked about 88 bytes of data (roughly 5-6 UUID rows) inside it. Because the next UUID will be random, it might not even land in this page, forcing the DB to open yet another mostly-empty 8 KB page.\n31. Correcting the Correlation Query You attempted to check the Correlation (how closely the physical order of data on the disk matches the index order). This is a vital ‚ÄúDeep Planner‚Äù metric.\nYour query failed because public.organisation is a string value, and the tablename column in pg_stats does not include the schema prefix.\nThe Corrected SQL: 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 SELECT tablename, attname AS column_name, correlation FROM pg_stats WHERE tablename = 'organisation' AND schemaname = 'public'; Gemini said Here is the breakdown of your Organisation table statistics and the corrected query to view them, formatted for your technical records. Markdown ## 30. The \"Smoking Gun\": Analyzing the 1.08% Density The result you provided from `pgstatindex` (`avg_leaf_density: 1.08`) is the ultimate proof of the **UUID v4** problem. ### The Math of the 1.08% * **Page Size:** 8,192 bytes (8 KB). * **Used Space:** $8192 \\times 0.0108 = \\mathbf{88.47 \\text{ bytes}}$. * **Wasted Space:** **8,103 bytes**. Because your UUIDs are random, PostgreSQL had to allocate a full **8 KB page** (the \"warehouse\") but has only parked about 88 bytes of data (roughly 5-6 UUID rows) inside it. Because the next UUID will be random, it might not even land in this page, forcing the DB to open yet *another* mostly-empty 8 KB page. --- ## 31. Correcting the Correlation Query You attempted to check the **Correlation** (how closely the physical order of data on the disk matches the index order). This is a vital \"Deep Planner\" metric. Your query failed because `public.organisation` is a string value, and the `tablename` column in `pg_stats` does not include the schema prefix. ### The Corrected SQL: ```sql SELECT tablename, attname AS column_name, correlation FROM pg_stats WHERE tablename = 'organisation' AND schemaname = 'public'; How to interpret the \"Correlation\" result: Near 1.0: Perfectly ordered (Sequential). This is what you have in your topic table (Integers). Near 0.0: Totally random (Chaos). This is what happens with UUID v4. Near -1.0: Perfectly ordered, but in reverse. 32. Final Comparison: Topic vs. Organisation Feature\ttopic table\torganisation table ID Type\tInteger (Serial)\tUUID v4 (Random) 8 KB Strategy\tSequential: Fills pages 1 to 100 perfectly.\tRandom: Scatters data, leaving pages 99% empty. Density Score\t9.62% (Low only because it's new)\t1.08% (Dangerously low) Action Taken\tNone needed.\tSwitched to UUID v7. The \"Deep Planner\" Result By switching the organisation table to generate_uuid_v7(), you are ensuring that as your company grows, the correlation score will move toward 1.0 and the density_score will move toward 90%+. You have successfully optimized the \"DNA\" of your primary storage. ## 33. Understanding the \"High Bloat\" Alarm When you run a bloat query on a small or brand-new database, you will often see **\"HIGH BLOAT\"** warnings across every table. While the term sounds scary, for your current setup, it is a mathematical illusion. ### The \"Empty Parking Garage\" Effect Look at your `index_size` column. Most of your indexes are exactly **16 KB**. * **Page 1 (8 KB):** The Metapage (stores index version and internal rules). * **Page 2 (8 KB):** The Leaf Page (where your actual IDs live). Because you only have a few rows of data, you are only using a few bytes of that second 8 KB page. * **Calculation:** If you have 5 rows (approx. 100 bytes) in an 8,192-byte page, your density is **1.2%**. * **Result:** The query flags this as \"High Bloat\" because the \"room\" is 99% empty. --- ## 34. Current Index Health Report | Table Name | Index Name | Size | Density | Status | Deep Planner Verdict | | :--- | :--- | :--- | :--- | :--- | :--- | | **organisation** | `PK_c725...` | 16 KB | ~1.08% | HIGH BLOAT | **Healthy.** Just needs more rows to fill the page. | | **topic** | `topic_id_seq` | 16 KB | ~9.62% | HIGH BLOAT | **Healthy.** Since it's an Integer, it will fill up perfectly. | | **agent** | `PK_...` | 16 KB | Low | HIGH BLOAT | **Action Needed:** Apply UUID v7 default. | ### When does \"High Bloat\" actually become a problem? Bloat only matters when your index size is **Large (MBs or GBs)**. * **Small Index (16 KB):** A density of 1% is fine. It just means the table is new. * **Large Index (500 MB):** A density of 1% means you are wasting 495 MB of RAM on \"empty air.\" This is when you must run `REINDEX`. --- ## 35. The \"Search Vector\" Performance Check I noticed your `topic` table is also 16 KB. Even after your `UPDATE` to the `search_vector`, the table hasn't grown. This is good! It means: 1. Your `search_vector` data is relatively small. 2. PostgreSQL's **Auto-Vacuum** hasn't needed to create massive new pages yet. ### Final Verification Query To see how the `search_vector` specifically is affecting your **Table Density** (not just the index), run this: ```sql SELECT relname AS table_name, pg_size_pretty(pg_total_relation_size(relid)) AS total_size, pg_size_pretty(pg_table_size(relid)) AS data_size, pg_size_pretty(pg_indexes_size(relid)) AS index_size FROM pg_stat_user_tables WHERE relname = 'topic'; Gemini said Here is the breakdown of your Index Bloat report, formatted for your technical records. Markdown ## 33. Understanding the \"High Bloat\" Alarm When you run a bloat query on a small or brand-new database, you will often see **\"HIGH BLOAT\"** warnings across every table. While the term sounds scary, for your current setup, it is a mathematical illusion. ### The \"Empty Parking Garage\" Effect Look at your `index_size` column. Most of your indexes are exactly **16 KB**. * **Page 1 (8 KB):** The Metapage (stores index version and internal rules). * **Page 2 (8 KB):** The Leaf Page (where your actual IDs live). Because you only have a few rows of data, you are only using a few bytes of that second 8 KB page. * **Calculation:** If you have 5 rows (approx. 100 bytes) in an 8,192-byte page, your density is **1.2%**. * **Result:** The query flags this as \"High Bloat\" because the \"room\" is 99% empty. --- ## 34. Current Index Health Report | Table Name | Index Name | Size | Density | Status | Deep Planner Verdict | | :--- | :--- | :--- | :--- | :--- | :--- | | **organisation** | `PK_c725...` | 16 KB | ~1.08% | HIGH BLOAT | **Healthy.** Just needs more rows to fill the page. | | **topic** | `topic_id_seq` | 16 KB | ~9.62% | HIGH BLOAT | **Healthy.** Since it's an Integer, it will fill up perfectly. | | **agent** | `PK_...` | 16 KB | Low | HIGH BLOAT | **Action Needed:** Apply UUID v7 default. | ### When does \"High Bloat\" actually become a problem? Bloat only matters when your index size is **Large (MBs or GBs)**. * **Small Index (16 KB):** A density of 1% is fine. It just means the table is new. * **Large Index (500 MB):** A density of 1% means you are wasting 495 MB of RAM on \"empty air.\" This is when you must run `REINDEX`. --- ## 35. The \"Search Vector\" Performance Check I noticed your `topic` table is also 16 KB. Even after your `UPDATE` to the `search_vector`, the table hasn't grown. This is good! It means: 1. Your `search_vector` data is relatively small. 2. PostgreSQL's **Auto-Vacuum** hasn't needed to create massive new pages yet. ### Final Verification Query To see how the `search_vector` specifically is affecting your **Table Density** (not just the index), run this: ```sql SELECT relname AS table_name, pg_size_pretty(pg_total_relation_size(relid)) AS total_size, pg_size_pretty(pg_table_size(relid)) AS data_size, pg_size_pretty(pg_indexes_size(relid)) AS index_size FROM pg_stat_user_tables WHERE relname = 'topic'; Summary of your \"Deep Plan\" Progress You have successfully: Diagnosed the UUID v4 fragmentation. Implemented the UUID v7 generator for time-sorted IDs. Clustered your organisation table to reclaim empty space. Audited your index health to establish a performance baseline. --- **Your database is now \"tuned\" for growth.** Since we have secured the IDs and the B-Tree density, would you like to explore **GIN Indexes** (specifically for your `search_vector`) to see how they differ from standard B-Trees? ",
  "wordCount" : "1782",
  "inLanguage": "en",
  "datePublished": "2026-03-29T05:55:00Z",
  "dateModified": "2026-03-29T05:55:00Z",
  "author":{
    "@type": "Person",
    "name": "Rajesh Subramanian"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "http://localhost:1313/posts/drafts/part4-index-introduction/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Beyond the Bytes",
    "logo": {
      "@type": "ImageObject",
      "url": "http://localhost:1313/favicon.ico"
    }
  }
}
</script>
</head>
<body id="top">
    <header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="Beyond the Bytes (Alt + H)">Beyond the Bytes</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/about/" title="About">
                    <span>About</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/journey" title="My Journey">
                    <span>My Journey</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/posts/" title="Articles">
                    <span>Articles</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/categories/" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      Part 4 - Deep Dive: How Database Indexing Works (The B-Tree)
    </h1>
    <div class="post-meta"><span title='2026-03-29 05:55:00 +0000 UTC'>March 29, 2026</span>&nbsp;¬∑&nbsp;<span>9 min</span>&nbsp;¬∑&nbsp;<span>1782 words</span>&nbsp;¬∑&nbsp;<span>Rajesh Subramanian</span>

</div>
  </header> <div class="toc">
    <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#30-the-smoking-gun-analyzing-the-108-density" aria-label="30. The &ldquo;Smoking Gun&rdquo;: Analyzing the 1.08% Density">30. The &ldquo;Smoking Gun&rdquo;: Analyzing the 1.08% Density</a><ul>
                        
                <li>
                    <a href="#the-math-of-the-108" aria-label="The Math of the 1.08%">The Math of the 1.08%</a></li></ul>
                </li>
                <li>
                    <a href="#31-correcting-the-correlation-query" aria-label="31. Correcting the Correlation Query">31. Correcting the Correlation Query</a><ul>
                        
                <li>
                    <a href="#the-corrected-sql" aria-label="The Corrected SQL:">The Corrected SQL:</a>
                </li>
            </ul>
            </li>
            </ul>
        </div>
    </details>
</div>

  <aside class="series-box" style="padding: 15px; border: 1px solid var(--border); border-radius: 8px; margin: 20px 0; background: var(--tertiary);">
    <h4 style="margin-top: 0;">üìö Part of the <em>Introduction to Index</em> series</h4>
    <ul style="margin-bottom: 0; list-style: none; padding-left: 10px;"><li style="margin-bottom: 5px;"><a href="http://localhost:1313/posts/2026/03/22/part1-index-introduction/" style="text-decoration: none; color: var(--primary);">Part 1 - Deep Dive: How Database Indexing Works (The B-Tree)</a></li><li style="margin-bottom: 5px;"><a href="http://localhost:1313/posts/drafts/part3-index-introduction/" style="text-decoration: none; color: var(--primary);">Part 3 - Deep Dive: How Database Indexing Works (The B-Tree)</a></li><li style="margin-bottom: 5px;"><a href="http://localhost:1313/posts/2026/03/22/part2-index-introduction/" style="text-decoration: none; color: var(--primary);">Part 2 - Deep Dive: How Database Indexing Works (The B-Tree)</a></li><li style="margin-bottom: 5px;"><span style="color: var(--secondary); font-weight: bold;">üëâ Part 4 - Deep Dive: How Database Indexing Works (The B-Tree) (Current)</span></li></ul>
</aside>
  <div class="post-content"><ol start="28">
<li>The &ldquo;Heavy Data&rdquo; Reality: TSVectors</li>
</ol>
<p>I noticed you are building search_vector for your topic table using to_tsvector. This adds a new layer to our 8 KB Page math:</p>
<pre><code>The Box Size: Our UUID was 16 bytes. A tsvector of a description can be 500+ bytes.

The Denominator: Instead of fitting 819 entries in an 8 KB page, a search index (GIN index) might only fit 10-15 entries per page.

The Performance Impact: This is why Full-Text Search is &quot;heavy.&quot; Every search requires the CPU to decompress these large blocks and the Disk to fetch much larger pages.
</code></pre>
<ol start="29">
<li>Final Implementation Checklist (Postgres 17.7)</li>
</ol>
<p>Now that you have pgcrypto installed and the function tested, follow these steps to move your agent, user, and topic tables to the new standard:</p>
<p>Step,Action,SQL Command
1,Apply Default,ALTER TABLE agent ALTER COLUMN id SET DEFAULT generate_uuid_v7();
2,Apply Default,ALTER TABLE topic ALTER COLUMN id SET DEFAULT generate_uuid_v7();
3,Repack Pages,REINDEX TABLE agent;
4,Verify,Run the Density Query again to see the score move closer to 0.9+.</p>
<h2 id="30-the-smoking-gun-analyzing-the-108-density">30. The &ldquo;Smoking Gun&rdquo;: Analyzing the 1.08% Density<a hidden class="anchor" aria-hidden="true" href="#30-the-smoking-gun-analyzing-the-108-density">#</a></h2>
<p>The result you provided from <code>pgstatindex</code> (<code>avg_leaf_density: 1.08</code>) is the ultimate proof of the <strong>UUID v4</strong> problem.</p>
<h3 id="the-math-of-the-108">The Math of the 1.08%<a hidden class="anchor" aria-hidden="true" href="#the-math-of-the-108">#</a></h3>
<ul>
<li><strong>Page Size:</strong> 8,192 bytes (8 KB).</li>
<li><strong>Used Space:</strong> $8192 \times 0.0108 = \mathbf{88.47 \text{ bytes}}$.</li>
<li><strong>Wasted Space:</strong> <strong>8,103 bytes</strong>.</li>
</ul>
<p>Because your UUIDs are random, PostgreSQL had to allocate a full <strong>8 KB page</strong> (the &ldquo;warehouse&rdquo;) but has only parked about 88 bytes of data (roughly 5-6 UUID rows) inside it. Because the next UUID will be random, it might not even land in this page, forcing the DB to open yet <em>another</em> mostly-empty 8 KB page.</p>
<hr>
<h2 id="31-correcting-the-correlation-query">31. Correcting the Correlation Query<a hidden class="anchor" aria-hidden="true" href="#31-correcting-the-correlation-query">#</a></h2>
<p>You attempted to check the <strong>Correlation</strong> (how closely the physical order of data on the disk matches the index order). This is a vital &ldquo;Deep Planner&rdquo; metric.</p>
<p>Your query failed because <code>public.organisation</code> is a string value, and the <code>tablename</code> column in <code>pg_stats</code> does not include the schema prefix.</p>
<h3 id="the-corrected-sql">The Corrected SQL:<a hidden class="anchor" aria-hidden="true" href="#the-corrected-sql">#</a></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">tablename</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">attname</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="k">column_name</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">correlation</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="k">FROM</span><span class="w"> </span><span class="n">pg_stats</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="k">WHERE</span><span class="w"> </span><span class="n">tablename</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;organisation&#39;</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="k">AND</span><span class="w"> </span><span class="n">schemaname</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;public&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="n">Gemini</span><span class="w"> </span><span class="n">said</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">Here</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">breakdown</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">your</span><span class="w"> </span><span class="n">Organisation</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="k">statistics</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">corrected</span><span class="w"> </span><span class="n">query</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="k">view</span><span class="w"> </span><span class="n">them</span><span class="p">,</span><span class="w"> </span><span class="n">formatted</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">your</span><span class="w"> </span><span class="n">technical</span><span class="w"> </span><span class="n">records</span><span class="p">.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">Markdown</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="o">##</span><span class="w"> </span><span class="mi">30</span><span class="p">.</span><span class="w"> </span><span class="n">The</span><span class="w"> </span><span class="s2">&#34;Smoking Gun&#34;</span><span class="p">:</span><span class="w"> </span><span class="n">Analyzing</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="mi">1</span><span class="p">.</span><span class="mi">08</span><span class="o">%</span><span class="w"> </span><span class="n">Density</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">The</span><span class="w"> </span><span class="k">result</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="n">provided</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="o">`</span><span class="n">pgstatindex</span><span class="o">`</span><span class="w"> </span><span class="p">(</span><span class="o">`</span><span class="n">avg_leaf_density</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">.</span><span class="mi">08</span><span class="o">`</span><span class="p">)</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">ultimate</span><span class="w"> </span><span class="n">proof</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="o">**</span><span class="n">UUID</span><span class="w"> </span><span class="n">v4</span><span class="o">**</span><span class="w"> </span><span class="n">problem</span><span class="p">.</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="o">###</span><span class="w"> </span><span class="n">The</span><span class="w"> </span><span class="n">Math</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="mi">1</span><span class="p">.</span><span class="mi">08</span><span class="o">%</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="o">*</span><span class="w"> </span><span class="o">**</span><span class="n">Page</span><span class="w"> </span><span class="k">Size</span><span class="p">:</span><span class="o">**</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="mi">192</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">KB</span><span class="p">).</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="o">*</span><span class="w"> </span><span class="o">**</span><span class="n">Used</span><span class="w"> </span><span class="k">Space</span><span class="p">:</span><span class="o">**</span><span class="w"> </span><span class="err">$</span><span class="mi">8192</span><span class="w"> </span><span class="err">\</span><span class="n">times</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">0108</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">\</span><span class="n">mathbf</span><span class="err">{</span><span class="mi">88</span><span class="p">.</span><span class="mi">47</span><span class="w"> </span><span class="err">\</span><span class="nb">text</span><span class="err">{</span><span class="w"> </span><span class="n">bytes</span><span class="err">}}$</span><span class="p">.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="o">*</span><span class="w"> </span><span class="o">**</span><span class="n">Wasted</span><span class="w"> </span><span class="k">Space</span><span class="p">:</span><span class="o">**</span><span class="w"> </span><span class="o">**</span><span class="mi">8</span><span class="p">,</span><span class="mi">103</span><span class="w"> </span><span class="n">bytes</span><span class="o">**</span><span class="p">.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">Because</span><span class="w"> </span><span class="n">your</span><span class="w"> </span><span class="n">UUIDs</span><span class="w"> </span><span class="k">are</span><span class="w"> </span><span class="n">random</span><span class="p">,</span><span class="w"> </span><span class="n">PostgreSQL</span><span class="w"> </span><span class="n">had</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="k">allocate</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="k">full</span><span class="w"> </span><span class="o">**</span><span class="mi">8</span><span class="w"> </span><span class="n">KB</span><span class="w"> </span><span class="n">page</span><span class="o">**</span><span class="w"> </span><span class="p">(</span><span class="n">the</span><span class="w"> </span><span class="s2">&#34;warehouse&#34;</span><span class="p">)</span><span class="w"> </span><span class="n">but</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="k">only</span><span class="w"> </span><span class="n">parked</span><span class="w"> </span><span class="n">about</span><span class="w"> </span><span class="mi">88</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="k">data</span><span class="w"> </span><span class="p">(</span><span class="n">roughly</span><span class="w"> </span><span class="mi">5</span><span class="o">-</span><span class="mi">6</span><span class="w"> </span><span class="n">UUID</span><span class="w"> </span><span class="k">rows</span><span class="p">)</span><span class="w"> </span><span class="n">inside</span><span class="w"> </span><span class="n">it</span><span class="p">.</span><span class="w"> </span><span class="n">Because</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">next</span><span class="w"> </span><span class="n">UUID</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">random</span><span class="p">,</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="n">might</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="n">even</span><span class="w"> </span><span class="n">land</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">page</span><span class="p">,</span><span class="w"> </span><span class="n">forcing</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">DB</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="k">open</span><span class="w"> </span><span class="n">yet</span><span class="w"> </span><span class="o">*</span><span class="n">another</span><span class="o">*</span><span class="w"> </span><span class="n">mostly</span><span class="o">-</span><span class="n">empty</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="n">KB</span><span class="w"> </span><span class="n">page</span><span class="p">.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="c1">---
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="o">##</span><span class="w"> </span><span class="mi">31</span><span class="p">.</span><span class="w"> </span><span class="n">Correcting</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">Correlation</span><span class="w"> </span><span class="n">Query</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">You</span><span class="w"> </span><span class="n">attempted</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="k">check</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="o">**</span><span class="n">Correlation</span><span class="o">**</span><span class="w"> </span><span class="p">(</span><span class="n">how</span><span class="w"> </span><span class="n">closely</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">physical</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="k">data</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">disk</span><span class="w"> </span><span class="n">matches</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">index</span><span class="w"> </span><span class="k">order</span><span class="p">).</span><span class="w"> </span><span class="n">This</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">vital</span><span class="w"> </span><span class="s2">&#34;Deep Planner&#34;</span><span class="w"> </span><span class="n">metric</span><span class="p">.</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">Your</span><span class="w"> </span><span class="n">query</span><span class="w"> </span><span class="n">failed</span><span class="w"> </span><span class="n">because</span><span class="w"> </span><span class="o">`</span><span class="k">public</span><span class="p">.</span><span class="n">organisation</span><span class="o">`</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="o">`</span><span class="n">tablename</span><span class="o">`</span><span class="w"> </span><span class="k">column</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="o">`</span><span class="n">pg_stats</span><span class="o">`</span><span class="w"> </span><span class="n">does</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="n">include</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">schema</span><span class="w"> </span><span class="k">prefix</span><span class="p">.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="o">###</span><span class="w"> </span><span class="n">The</span><span class="w"> </span><span class="n">Corrected</span><span class="w"> </span><span class="k">SQL</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="o">```</span><span class="k">sql</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">tablename</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">attname</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="k">column_name</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">correlation</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="k">FROM</span><span class="w"> </span><span class="n">pg_stats</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="k">WHERE</span><span class="w"> </span><span class="n">tablename</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;organisation&#39;</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="k">AND</span><span class="w"> </span><span class="n">schemaname</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;public&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">How</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">interpret</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="s2">&#34;Correlation&#34;</span><span class="w"> </span><span class="k">result</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Near</span><span class="w"> </span><span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="p">:</span><span class="w"> </span><span class="n">Perfectly</span><span class="w"> </span><span class="n">ordered</span><span class="w"> </span><span class="p">(</span><span class="n">Sequential</span><span class="p">).</span><span class="w"> </span><span class="n">This</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">what</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="n">have</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">your</span><span class="w"> </span><span class="n">topic</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="p">(</span><span class="n">Integers</span><span class="p">).</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Near</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">:</span><span class="w"> </span><span class="n">Totally</span><span class="w"> </span><span class="n">random</span><span class="w"> </span><span class="p">(</span><span class="n">Chaos</span><span class="p">).</span><span class="w"> </span><span class="n">This</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">what</span><span class="w"> </span><span class="n">happens</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">UUID</span><span class="w"> </span><span class="n">v4</span><span class="p">.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Near</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="p">:</span><span class="w"> </span><span class="n">Perfectly</span><span class="w"> </span><span class="n">ordered</span><span class="p">,</span><span class="w"> </span><span class="n">but</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">reverse</span><span class="p">.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="mi">32</span><span class="p">.</span><span class="w"> </span><span class="k">Final</span><span class="w"> </span><span class="n">Comparison</span><span class="p">:</span><span class="w"> </span><span class="n">Topic</span><span class="w"> </span><span class="n">vs</span><span class="p">.</span><span class="w"> </span><span class="n">Organisation</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">Feature</span><span class="w">	</span><span class="n">topic</span><span class="w"> </span><span class="k">table</span><span class="w">	</span><span class="n">organisation</span><span class="w"> </span><span class="k">table</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">ID</span><span class="w"> </span><span class="k">Type</span><span class="w">	</span><span class="nb">Integer</span><span class="w"> </span><span class="p">(</span><span class="nb">Serial</span><span class="p">)</span><span class="w">	</span><span class="n">UUID</span><span class="w"> </span><span class="n">v4</span><span class="w"> </span><span class="p">(</span><span class="n">Random</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="mi">8</span><span class="w"> </span><span class="n">KB</span><span class="w"> </span><span class="n">Strategy</span><span class="w">	</span><span class="n">Sequential</span><span class="p">:</span><span class="w"> </span><span class="n">Fills</span><span class="w"> </span><span class="n">pages</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="n">perfectly</span><span class="p">.</span><span class="w">	</span><span class="n">Random</span><span class="p">:</span><span class="w"> </span><span class="n">Scatters</span><span class="w"> </span><span class="k">data</span><span class="p">,</span><span class="w"> </span><span class="n">leaving</span><span class="w"> </span><span class="n">pages</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="w"> </span><span class="n">empty</span><span class="p">.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">Density</span><span class="w"> </span><span class="n">Score</span><span class="w">	</span><span class="mi">9</span><span class="p">.</span><span class="mi">62</span><span class="o">%</span><span class="w"> </span><span class="p">(</span><span class="n">Low</span><span class="w"> </span><span class="k">only</span><span class="w"> </span><span class="n">because</span><span class="w"> </span><span class="n">it</span><span class="s1">&#39;s new)	1.08% (Dangerously low)
</span></span></span><span class="line"><span class="cl"><span class="s1">Action Taken	None needed.	Switched to UUID v7.
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">The &#34;Deep Planner&#34; Result
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">By switching the organisation table to generate_uuid_v7(), you are ensuring that as your company grows, the correlation score will move toward 1.0 and the density_score will move toward 90%+. You have successfully optimized the &#34;DNA&#34; of your primary storage.
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">## 33. Understanding the &#34;High Bloat&#34; Alarm
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">When you run a bloat query on a small or brand-new database, you will often see **&#34;HIGH BLOAT&#34;** warnings across every table. While the term sounds scary, for your current setup, it is a mathematical illusion.
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">### The &#34;Empty Parking Garage&#34; Effect
</span></span></span><span class="line"><span class="cl"><span class="s1">Look at your `index_size` column. Most of your indexes are exactly **16 KB**.
</span></span></span><span class="line"><span class="cl"><span class="s1">* **Page 1 (8 KB):** The Metapage (stores index version and internal rules).
</span></span></span><span class="line"><span class="cl"><span class="s1">* **Page 2 (8 KB):** The Leaf Page (where your actual IDs live).
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">Because you only have a few rows of data, you are only using a few bytes of that second 8 KB page. 
</span></span></span><span class="line"><span class="cl"><span class="s1">* **Calculation:** If you have 5 rows (approx. 100 bytes) in an 8,192-byte page, your density is **1.2%**.
</span></span></span><span class="line"><span class="cl"><span class="s1">* **Result:** The query flags this as &#34;High Bloat&#34; because the &#34;room&#34; is 99% empty.
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">---
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">## 34. Current Index Health Report
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">| Table Name | Index Name | Size | Density | Status | Deep Planner Verdict |
</span></span></span><span class="line"><span class="cl"><span class="s1">| :--- | :--- | :--- | :--- | :--- | :--- |
</span></span></span><span class="line"><span class="cl"><span class="s1">| **organisation** | `PK_c725...` | 16 KB | ~1.08% | HIGH BLOAT | **Healthy.** Just needs more rows to fill the page. |
</span></span></span><span class="line"><span class="cl"><span class="s1">| **topic** | `topic_id_seq` | 16 KB | ~9.62% | HIGH BLOAT | **Healthy.** Since it&#39;</span><span class="n">s</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="nb">Integer</span><span class="p">,</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">fill</span><span class="w"> </span><span class="n">up</span><span class="w"> </span><span class="n">perfectly</span><span class="p">.</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="o">|</span><span class="w"> </span><span class="o">**</span><span class="n">agent</span><span class="o">**</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">`</span><span class="n">PK_</span><span class="p">...</span><span class="o">`</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">16</span><span class="w"> </span><span class="n">KB</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Low</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">HIGH</span><span class="w"> </span><span class="n">BLOAT</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">**</span><span class="n">Action</span><span class="w"> </span><span class="n">Needed</span><span class="p">:</span><span class="o">**</span><span class="w"> </span><span class="n">Apply</span><span class="w"> </span><span class="n">UUID</span><span class="w"> </span><span class="n">v7</span><span class="w"> </span><span class="k">default</span><span class="p">.</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="o">###</span><span class="w"> </span><span class="k">When</span><span class="w"> </span><span class="n">does</span><span class="w"> </span><span class="s2">&#34;High Bloat&#34;</span><span class="w"> </span><span class="n">actually</span><span class="w"> </span><span class="n">become</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">problem</span><span class="o">?</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">Bloat</span><span class="w"> </span><span class="k">only</span><span class="w"> </span><span class="n">matters</span><span class="w"> </span><span class="k">when</span><span class="w"> </span><span class="n">your</span><span class="w"> </span><span class="k">index</span><span class="w"> </span><span class="k">size</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="o">**</span><span class="k">Large</span><span class="w"> </span><span class="p">(</span><span class="n">MBs</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="n">GBs</span><span class="p">)</span><span class="o">**</span><span class="p">.</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="o">*</span><span class="w"> </span><span class="o">**</span><span class="n">Small</span><span class="w"> </span><span class="k">Index</span><span class="w"> </span><span class="p">(</span><span class="mi">16</span><span class="w"> </span><span class="n">KB</span><span class="p">):</span><span class="o">**</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="n">density</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="mi">1</span><span class="o">%</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">fine</span><span class="p">.</span><span class="w"> </span><span class="n">It</span><span class="w"> </span><span class="n">just</span><span class="w"> </span><span class="n">means</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="k">new</span><span class="p">.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="o">*</span><span class="w"> </span><span class="o">**</span><span class="k">Large</span><span class="w"> </span><span class="k">Index</span><span class="w"> </span><span class="p">(</span><span class="mi">500</span><span class="w"> </span><span class="n">MB</span><span class="p">):</span><span class="o">**</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="n">density</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="mi">1</span><span class="o">%</span><span class="w"> </span><span class="n">means</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="k">are</span><span class="w"> </span><span class="n">wasting</span><span class="w"> </span><span class="mi">495</span><span class="w"> </span><span class="n">MB</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">RAM</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="s2">&#34;empty air.&#34;</span><span class="w"> </span><span class="n">This</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="k">when</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="n">must</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">`</span><span class="k">REINDEX</span><span class="o">`</span><span class="p">.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="c1">---
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="o">##</span><span class="w"> </span><span class="mi">35</span><span class="p">.</span><span class="w"> </span><span class="n">The</span><span class="w"> </span><span class="s2">&#34;Search Vector&#34;</span><span class="w"> </span><span class="n">Performance</span><span class="w"> </span><span class="k">Check</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">I</span><span class="w"> </span><span class="n">noticed</span><span class="w"> </span><span class="n">your</span><span class="w"> </span><span class="o">`</span><span class="n">topic</span><span class="o">`</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">also</span><span class="w"> </span><span class="mi">16</span><span class="w"> </span><span class="n">KB</span><span class="p">.</span><span class="w"> </span><span class="n">Even</span><span class="w"> </span><span class="k">after</span><span class="w"> </span><span class="n">your</span><span class="w"> </span><span class="o">`</span><span class="k">UPDATE</span><span class="o">`</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="o">`</span><span class="n">search_vector</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">hasn</span><span class="s1">&#39;t grown. This is good! It means:
</span></span></span><span class="line"><span class="cl"><span class="s1">1.  Your `search_vector` data is relatively small.
</span></span></span><span class="line"><span class="cl"><span class="s1">2.  PostgreSQL&#39;</span><span class="n">s</span><span class="w"> </span><span class="o">**</span><span class="n">Auto</span><span class="o">-</span><span class="k">Vacuum</span><span class="o">**</span><span class="w"> </span><span class="n">hasn</span><span class="s1">&#39;t needed to create massive new pages yet.
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">### Final Verification Query
</span></span></span><span class="line"><span class="cl"><span class="s1">To see how the `search_vector` specifically is affecting your **Table Density** (not just the index), run this:
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">```sql
</span></span></span><span class="line"><span class="cl"><span class="s1">SELECT 
</span></span></span><span class="line"><span class="cl"><span class="s1">    relname AS table_name, 
</span></span></span><span class="line"><span class="cl"><span class="s1">    pg_size_pretty(pg_total_relation_size(relid)) AS total_size,
</span></span></span><span class="line"><span class="cl"><span class="s1">    pg_size_pretty(pg_table_size(relid)) AS data_size,
</span></span></span><span class="line"><span class="cl"><span class="s1">    pg_size_pretty(pg_indexes_size(relid)) AS index_size
</span></span></span><span class="line"><span class="cl"><span class="s1">FROM pg_stat_user_tables 
</span></span></span><span class="line"><span class="cl"><span class="s1">WHERE relname = &#39;</span><span class="n">topic</span><span class="s1">&#39;;
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1"> Gemini said
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">Here is the breakdown of your Index Bloat report, formatted for your technical records.
</span></span></span><span class="line"><span class="cl"><span class="s1">Markdown
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">## 33. Understanding the &#34;High Bloat&#34; Alarm
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">When you run a bloat query on a small or brand-new database, you will often see **&#34;HIGH BLOAT&#34;** warnings across every table. While the term sounds scary, for your current setup, it is a mathematical illusion.
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">### The &#34;Empty Parking Garage&#34; Effect
</span></span></span><span class="line"><span class="cl"><span class="s1">Look at your `index_size` column. Most of your indexes are exactly **16 KB**.
</span></span></span><span class="line"><span class="cl"><span class="s1">* **Page 1 (8 KB):** The Metapage (stores index version and internal rules).
</span></span></span><span class="line"><span class="cl"><span class="s1">* **Page 2 (8 KB):** The Leaf Page (where your actual IDs live).
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">Because you only have a few rows of data, you are only using a few bytes of that second 8 KB page. 
</span></span></span><span class="line"><span class="cl"><span class="s1">* **Calculation:** If you have 5 rows (approx. 100 bytes) in an 8,192-byte page, your density is **1.2%**.
</span></span></span><span class="line"><span class="cl"><span class="s1">* **Result:** The query flags this as &#34;High Bloat&#34; because the &#34;room&#34; is 99% empty.
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">---
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">## 34. Current Index Health Report
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">| Table Name | Index Name | Size | Density | Status | Deep Planner Verdict |
</span></span></span><span class="line"><span class="cl"><span class="s1">| :--- | :--- | :--- | :--- | :--- | :--- |
</span></span></span><span class="line"><span class="cl"><span class="s1">| **organisation** | `PK_c725...` | 16 KB | ~1.08% | HIGH BLOAT | **Healthy.** Just needs more rows to fill the page. |
</span></span></span><span class="line"><span class="cl"><span class="s1">| **topic** | `topic_id_seq` | 16 KB | ~9.62% | HIGH BLOAT | **Healthy.** Since it&#39;</span><span class="n">s</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="nb">Integer</span><span class="p">,</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">fill</span><span class="w"> </span><span class="n">up</span><span class="w"> </span><span class="n">perfectly</span><span class="p">.</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="o">|</span><span class="w"> </span><span class="o">**</span><span class="n">agent</span><span class="o">**</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">`</span><span class="n">PK_</span><span class="p">...</span><span class="o">`</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">16</span><span class="w"> </span><span class="n">KB</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Low</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">HIGH</span><span class="w"> </span><span class="n">BLOAT</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">**</span><span class="n">Action</span><span class="w"> </span><span class="n">Needed</span><span class="p">:</span><span class="o">**</span><span class="w"> </span><span class="n">Apply</span><span class="w"> </span><span class="n">UUID</span><span class="w"> </span><span class="n">v7</span><span class="w"> </span><span class="k">default</span><span class="p">.</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="o">###</span><span class="w"> </span><span class="k">When</span><span class="w"> </span><span class="n">does</span><span class="w"> </span><span class="s2">&#34;High Bloat&#34;</span><span class="w"> </span><span class="n">actually</span><span class="w"> </span><span class="n">become</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">problem</span><span class="o">?</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">Bloat</span><span class="w"> </span><span class="k">only</span><span class="w"> </span><span class="n">matters</span><span class="w"> </span><span class="k">when</span><span class="w"> </span><span class="n">your</span><span class="w"> </span><span class="k">index</span><span class="w"> </span><span class="k">size</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="o">**</span><span class="k">Large</span><span class="w"> </span><span class="p">(</span><span class="n">MBs</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="n">GBs</span><span class="p">)</span><span class="o">**</span><span class="p">.</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="o">*</span><span class="w"> </span><span class="o">**</span><span class="n">Small</span><span class="w"> </span><span class="k">Index</span><span class="w"> </span><span class="p">(</span><span class="mi">16</span><span class="w"> </span><span class="n">KB</span><span class="p">):</span><span class="o">**</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="n">density</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="mi">1</span><span class="o">%</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">fine</span><span class="p">.</span><span class="w"> </span><span class="n">It</span><span class="w"> </span><span class="n">just</span><span class="w"> </span><span class="n">means</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="k">new</span><span class="p">.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="o">*</span><span class="w"> </span><span class="o">**</span><span class="k">Large</span><span class="w"> </span><span class="k">Index</span><span class="w"> </span><span class="p">(</span><span class="mi">500</span><span class="w"> </span><span class="n">MB</span><span class="p">):</span><span class="o">**</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="n">density</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="mi">1</span><span class="o">%</span><span class="w"> </span><span class="n">means</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="k">are</span><span class="w"> </span><span class="n">wasting</span><span class="w"> </span><span class="mi">495</span><span class="w"> </span><span class="n">MB</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">RAM</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="s2">&#34;empty air.&#34;</span><span class="w"> </span><span class="n">This</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="k">when</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="n">must</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">`</span><span class="k">REINDEX</span><span class="o">`</span><span class="p">.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="c1">---
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="o">##</span><span class="w"> </span><span class="mi">35</span><span class="p">.</span><span class="w"> </span><span class="n">The</span><span class="w"> </span><span class="s2">&#34;Search Vector&#34;</span><span class="w"> </span><span class="n">Performance</span><span class="w"> </span><span class="k">Check</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">I</span><span class="w"> </span><span class="n">noticed</span><span class="w"> </span><span class="n">your</span><span class="w"> </span><span class="o">`</span><span class="n">topic</span><span class="o">`</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">also</span><span class="w"> </span><span class="mi">16</span><span class="w"> </span><span class="n">KB</span><span class="p">.</span><span class="w"> </span><span class="n">Even</span><span class="w"> </span><span class="k">after</span><span class="w"> </span><span class="n">your</span><span class="w"> </span><span class="o">`</span><span class="k">UPDATE</span><span class="o">`</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="o">`</span><span class="n">search_vector</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">hasn</span><span class="s1">&#39;t grown. This is good! It means:
</span></span></span><span class="line"><span class="cl"><span class="s1">1.  Your `search_vector` data is relatively small.
</span></span></span><span class="line"><span class="cl"><span class="s1">2.  PostgreSQL&#39;</span><span class="n">s</span><span class="w"> </span><span class="o">**</span><span class="n">Auto</span><span class="o">-</span><span class="k">Vacuum</span><span class="o">**</span><span class="w"> </span><span class="n">hasn</span><span class="s1">&#39;t needed to create massive new pages yet.
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">### Final Verification Query
</span></span></span><span class="line"><span class="cl"><span class="s1">To see how the `search_vector` specifically is affecting your **Table Density** (not just the index), run this:
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">```sql
</span></span></span><span class="line"><span class="cl"><span class="s1">SELECT 
</span></span></span><span class="line"><span class="cl"><span class="s1">    relname AS table_name, 
</span></span></span><span class="line"><span class="cl"><span class="s1">    pg_size_pretty(pg_total_relation_size(relid)) AS total_size,
</span></span></span><span class="line"><span class="cl"><span class="s1">    pg_size_pretty(pg_table_size(relid)) AS data_size,
</span></span></span><span class="line"><span class="cl"><span class="s1">    pg_size_pretty(pg_indexes_size(relid)) AS index_size
</span></span></span><span class="line"><span class="cl"><span class="s1">FROM pg_stat_user_tables 
</span></span></span><span class="line"><span class="cl"><span class="s1">WHERE relname = &#39;</span><span class="n">topic</span><span class="s1">&#39;;
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">Summary of your &#34;Deep Plan&#34; Progress
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">You have successfully:
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">    Diagnosed the UUID v4 fragmentation.
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">    Implemented the UUID v7 generator for time-sorted IDs.
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">    Clustered your organisation table to reclaim empty space.
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">    Audited your index health to establish a performance baseline.
</span></span></span><span class="line"><span class="cl"><span class="s1">    
</span></span></span><span class="line"><span class="cl"><span class="s1">    
</span></span></span><span class="line"><span class="cl"><span class="s1">    
</span></span></span><span class="line"><span class="cl"><span class="s1">    ---
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">**Your database is now &#34;tuned&#34; for growth.** Since we have secured the IDs and the B-Tree density, would you like to explore **GIN Indexes** (specifically for your `search_vector`) to see how they differ from standard B-Trees?
</span></span></span></code></pre></td></tr></table>
</div>
</div>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="http://localhost:1313/tags/databases/">Databases</a></li>
      <li><a href="http://localhost:1313/tags/performance/">Performance</a></li>
      <li><a href="http://localhost:1313/tags/computer-science/">Computer Science</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="http://localhost:1313/posts/2026/03/22/part2-index-introduction/">
    <span class="title">¬´ Prev</span>
    <br>
    <span>Part 2 - Deep Dive: How Database Indexing Works (The B-Tree)</span>
  </a>
  <a class="next" href="http://localhost:1313/posts/2026/03/22/part1-index-introduction/">
    <span class="title">Next ¬ª</span>
    <br>
    <span>Part 1 - Deep Dive: How Database Indexing Works (The B-Tree)</span>
  </a>
</nav>


<ul class="share-buttons">
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Part 4 - Deep Dive: How Database Indexing Works (The B-Tree) on x"
            href="https://x.com/intent/tweet/?text=Part%204%20-%20Deep%20Dive%3a%20How%20Database%20Indexing%20Works%20%28The%20B-Tree%29&amp;url=http%3a%2f%2flocalhost%3a1313%2fposts%2fdrafts%2fpart4-index-introduction%2f&amp;hashtags=Databases%2cPerformance%2cComputerScience">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M512 62.554 L 512 449.446 C 512 483.97 483.97 512 449.446 512 L 62.554 512 C 28.03 512 0 483.97 0 449.446 L 0 62.554 C 0 28.03 28.029 0 62.554 0 L 449.446 0 C 483.971 0 512 28.03 512 62.554 Z M 269.951 190.75 L 182.567 75.216 L 56 75.216 L 207.216 272.95 L 63.9 436.783 L 125.266 436.783 L 235.9 310.383 L 332.567 436.783 L 456 436.783 L 298.367 228.367 L 432.367 75.216 L 371.033 75.216 Z M 127.633 110 L 164.101 110 L 383.481 400.065 L 349.5 400.065 Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Part 4 - Deep Dive: How Database Indexing Works (The B-Tree) on linkedin"
            href="https://www.linkedin.com/shareArticle?mini=true&amp;url=http%3a%2f%2flocalhost%3a1313%2fposts%2fdrafts%2fpart4-index-introduction%2f&amp;title=Part%204%20-%20Deep%20Dive%3a%20How%20Database%20Indexing%20Works%20%28The%20B-Tree%29&amp;summary=Part%204%20-%20Deep%20Dive%3a%20How%20Database%20Indexing%20Works%20%28The%20B-Tree%29&amp;source=http%3a%2f%2flocalhost%3a1313%2fposts%2fdrafts%2fpart4-index-introduction%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-288.985,423.278l0,-225.717l-75.04,0l0,225.717l75.04,0Zm270.539,0l0,-129.439c0,-69.333 -37.018,-101.586 -86.381,-101.586c-39.804,0 -57.634,21.891 -67.617,37.266l0,-31.958l-75.021,0c0.995,21.181 0,225.717 0,225.717l75.02,0l0,-126.056c0,-6.748 0.486,-13.492 2.474,-18.315c5.414,-13.475 17.767,-27.434 38.494,-27.434c27.135,0 38.007,20.707 38.007,51.037l0,120.768l75.024,0Zm-307.552,-334.556c-25.674,0 -42.448,16.879 -42.448,39.002c0,21.658 16.264,39.002 41.455,39.002l0.484,0c26.165,0 42.452,-17.344 42.452,-39.002c-0.485,-22.092 -16.241,-38.954 -41.943,-39.002Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Part 4 - Deep Dive: How Database Indexing Works (The B-Tree) on reddit"
            href="https://reddit.com/submit?url=http%3a%2f%2flocalhost%3a1313%2fposts%2fdrafts%2fpart4-index-introduction%2f&title=Part%204%20-%20Deep%20Dive%3a%20How%20Database%20Indexing%20Works%20%28The%20B-Tree%29">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-3.446,265.638c0,-22.964 -18.616,-41.58 -41.58,-41.58c-11.211,0 -21.361,4.457 -28.841,11.666c-28.424,-20.508 -67.586,-33.757 -111.204,-35.278l18.941,-89.121l61.884,13.157c0.756,15.734 13.642,28.29 29.56,28.29c16.407,0 29.706,-13.299 29.706,-29.701c0,-16.403 -13.299,-29.702 -29.706,-29.702c-11.666,0 -21.657,6.792 -26.515,16.578l-69.105,-14.69c-1.922,-0.418 -3.939,-0.042 -5.585,1.036c-1.658,1.073 -2.811,2.761 -3.224,4.686l-21.152,99.438c-44.258,1.228 -84.046,14.494 -112.837,35.232c-7.468,-7.164 -17.589,-11.591 -28.757,-11.591c-22.965,0 -41.585,18.616 -41.585,41.58c0,16.896 10.095,31.41 24.568,37.918c-0.639,4.135 -0.99,8.328 -0.99,12.576c0,63.977 74.469,115.836 166.33,115.836c91.861,0 166.334,-51.859 166.334,-115.836c0,-4.218 -0.347,-8.387 -0.977,-12.493c14.564,-6.47 24.735,-21.034 24.735,-38.001Zm-119.474,108.193c-20.27,20.241 -59.115,21.816 -70.534,21.816c-11.428,0 -50.277,-1.575 -70.522,-21.82c-3.007,-3.008 -3.007,-7.882 0,-10.889c3.003,-2.999 7.882,-3.003 10.885,0c12.777,12.781 40.11,17.317 59.637,17.317c19.522,0 46.86,-4.536 59.657,-17.321c3.016,-2.999 7.886,-2.995 10.885,0.008c3.008,3.011 3.003,7.882 -0.008,10.889Zm-5.23,-48.781c-16.373,0 -29.701,-13.324 -29.701,-29.698c0,-16.381 13.328,-29.714 29.701,-29.714c16.378,0 29.706,13.333 29.706,29.714c0,16.374 -13.328,29.698 -29.706,29.698Zm-160.386,-29.702c0,-16.381 13.328,-29.71 29.714,-29.71c16.369,0 29.689,13.329 29.689,29.71c0,16.373 -13.32,29.693 -29.689,29.693c-16.386,0 -29.714,-13.32 -29.714,-29.693Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Part 4 - Deep Dive: How Database Indexing Works (The B-Tree) on facebook"
            href="https://facebook.com/sharer/sharer.php?u=http%3a%2f%2flocalhost%3a1313%2fposts%2fdrafts%2fpart4-index-introduction%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-106.468,0l0,-192.915l66.6,0l12.672,-82.621l-79.272,0l0,-53.617c0,-22.603 11.073,-44.636 46.58,-44.636l36.042,0l0,-70.34c0,0 -32.71,-5.582 -63.982,-5.582c-65.288,0 -107.96,39.569 -107.96,111.204l0,62.971l-72.573,0l0,82.621l72.573,0l0,192.915l-191.104,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Part 4 - Deep Dive: How Database Indexing Works (The B-Tree) on whatsapp"
            href="https://api.whatsapp.com/send?text=Part%204%20-%20Deep%20Dive%3a%20How%20Database%20Indexing%20Works%20%28The%20B-Tree%29%20-%20http%3a%2f%2flocalhost%3a1313%2fposts%2fdrafts%2fpart4-index-introduction%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-58.673,127.703c-33.842,-33.881 -78.847,-52.548 -126.798,-52.568c-98.799,0 -179.21,80.405 -179.249,179.234c-0.013,31.593 8.241,62.428 23.927,89.612l-25.429,92.884l95.021,-24.925c26.181,14.28 55.659,21.807 85.658,21.816l0.074,0c98.789,0 179.206,-80.413 179.247,-179.243c0.018,-47.895 -18.61,-92.93 -52.451,-126.81Zm-126.797,275.782l-0.06,0c-26.734,-0.01 -52.954,-7.193 -75.828,-20.767l-5.441,-3.229l-56.386,14.792l15.05,-54.977l-3.542,-5.637c-14.913,-23.72 -22.791,-51.136 -22.779,-79.287c0.033,-82.142 66.867,-148.971 149.046,-148.971c39.793,0.014 77.199,15.531 105.329,43.692c28.128,28.16 43.609,65.592 43.594,105.4c-0.034,82.149 -66.866,148.983 -148.983,148.984Zm81.721,-111.581c-4.479,-2.242 -26.499,-13.075 -30.604,-14.571c-4.105,-1.495 -7.091,-2.241 -10.077,2.241c-2.986,4.483 -11.569,14.572 -14.182,17.562c-2.612,2.988 -5.225,3.364 -9.703,1.12c-4.479,-2.241 -18.91,-6.97 -36.017,-22.23c-13.314,-11.876 -22.304,-26.542 -24.916,-31.026c-2.612,-4.484 -0.279,-6.908 1.963,-9.14c2.016,-2.007 4.48,-5.232 6.719,-7.847c2.24,-2.615 2.986,-4.484 4.479,-7.472c1.493,-2.99 0.747,-5.604 -0.374,-7.846c-1.119,-2.241 -10.077,-24.288 -13.809,-33.256c-3.635,-8.733 -7.327,-7.55 -10.077,-7.688c-2.609,-0.13 -5.598,-0.158 -8.583,-0.158c-2.986,0 -7.839,1.121 -11.944,5.604c-4.105,4.484 -15.675,15.32 -15.675,37.364c0,22.046 16.048,43.342 18.287,46.332c2.24,2.99 31.582,48.227 76.511,67.627c10.685,4.615 19.028,7.371 25.533,9.434c10.728,3.41 20.492,2.929 28.209,1.775c8.605,-1.285 26.499,-10.833 30.231,-21.295c3.732,-10.464 3.732,-19.431 2.612,-21.298c-1.119,-1.869 -4.105,-2.99 -8.583,-5.232Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Part 4 - Deep Dive: How Database Indexing Works (The B-Tree) on telegram"
            href="https://telegram.me/share/url?text=Part%204%20-%20Deep%20Dive%3a%20How%20Database%20Indexing%20Works%20%28The%20B-Tree%29&amp;url=http%3a%2f%2flocalhost%3a1313%2fposts%2fdrafts%2fpart4-index-introduction%2f">
            <svg version="1.1" xml:space="preserve" viewBox="2 2 28 28" height="30px" width="30px" fill="currentColor">
                <path
                    d="M26.49,29.86H5.5a3.37,3.37,0,0,1-2.47-1,3.35,3.35,0,0,1-1-2.47V5.48A3.36,3.36,0,0,1,3,3,3.37,3.37,0,0,1,5.5,2h21A3.38,3.38,0,0,1,29,3a3.36,3.36,0,0,1,1,2.46V26.37a3.35,3.35,0,0,1-1,2.47A3.38,3.38,0,0,1,26.49,29.86Zm-5.38-6.71a.79.79,0,0,0,.85-.66L24.73,9.24a.55.55,0,0,0-.18-.46.62.62,0,0,0-.41-.17q-.08,0-16.53,6.11a.59.59,0,0,0-.41.59.57.57,0,0,0,.43.52l4,1.24,1.61,4.83a.62.62,0,0,0,.63.43.56.56,0,0,0,.4-.17L16.54,20l4.09,3A.9.9,0,0,0,21.11,23.15ZM13.8,20.71l-1.21-4q8.72-5.55,8.78-5.55c.15,0,.23,0,.23.16a.18.18,0,0,1,0,.06s-2.51,2.3-7.52,6.8Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Part 4 - Deep Dive: How Database Indexing Works (The B-Tree) on ycombinator"
            href="https://news.ycombinator.com/submitlink?t=Part%204%20-%20Deep%20Dive%3a%20How%20Database%20Indexing%20Works%20%28The%20B-Tree%29&u=http%3a%2f%2flocalhost%3a1313%2fposts%2fdrafts%2fpart4-index-introduction%2f">
            <svg version="1.1" xml:space="preserve" width="30px" height="30px" viewBox="0 0 512 512" fill="currentColor"
                xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape">
                <path
                    d="M449.446 0C483.971 0 512 28.03 512 62.554L512 449.446C512 483.97 483.97 512 449.446 512L62.554 512C28.03 512 0 483.97 0 449.446L0 62.554C0 28.03 28.029 0 62.554 0L449.446 0ZM183.8767 87.9921H121.8427L230.6673 292.4508V424.0079H281.3328V292.4508L390.1575 87.9921H328.1233L256 238.2489z" />
            </svg>
        </a>
    </li>
</ul>

  </footer><script src="https://giscus.app/client.js"
        data-repo="srajesh2712/srajesh2712.github.io"
        data-repo-id="R_kgDOOWPLLQ"
        data-category="General"
        data-category-id="DIC_kwDOOWPLLc4C2-RG"
        data-mapping="pathname"
        data-strict="0"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="bottom"
        data-theme="preferred_color_scheme"
        data-lang="en"
        crossorigin="anonymous"
        async>
</script>

</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2026 <a href="http://localhost:1313/">Beyond the Bytes</a></span> ¬∑ 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a><script src="https://cdn.jsdelivr.net/npm/medium-zoom@latest/dist/medium-zoom.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const zoom = mediumZoom('.post-content img:not(.cover-image)', {
            margin: 24,
            background: 'var(--theme)',
            scrollOffset: 0,
        });
    });
</script>

<script>
    let menu = document.getElementById('menu');
    if (menu) {
        
        const scrollPosition = localStorage.getItem("menu-scroll-position");
        if (scrollPosition) {
            menu.scrollLeft = parseInt(scrollPosition, 10);
        }
        
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        const html = document.querySelector("html");
        if (html.dataset.theme === "dark") {
            html.dataset.theme = 'light';
            localStorage.setItem("pref-theme", 'light');
        } else {
            html.dataset.theme = 'dark';
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
